# Google Cloud Scheduler設定 (毎日17:00実行)
name: projects/effective-shore-r41fc/locations/us-central1/jobs/daily-training-data-batch
description: "毎日17:00に訓練データ生成バッチジョブを実行"
schedule: "0 17 * * *"
timeZone: "Asia/Tokyo"

# HTTP エンドポイント経由でBatchジョブを起動
httpTarget:
  uri: https://batch.googleapis.com/v1/projects/effective-shore-r41fc/locations/us-central1/jobs
  httpMethod: POST
  headers:
    Content-Type: application/json
  body: |
    {
      "job": {
        "taskGroups": [
          {
            "name": "training-data-workers",
            "taskSpec": {
              "runnables": [
                {
                  "container": {
                    "imageUri": "gcr.io/effective-shore-r41fc/training-data-generator:latest",
                    "entrypoint": "python3",
                    "commands": ["/app/parallel_training_data_generator.py"]
                  },
                  "environment": {
                    "variables": {
                      "DB_HOST": "34.58.103.36",
                      "DB_USER": "miraikakaku-user",
                      "DB_PASSWORD": "miraikakaku-secure-pass-2024",
                      "DB_NAME": "miraikakaku",
                      "BATCH_SIZE": "100",
                      "PREDICTIONS_PER_STOCK": "50"
                    }
                  }
                }
              ],
              "computeResource": {
                "cpuMilli": 2000,
                "memoryMib": 4096
              },
              "maxRetryCount": 2,
              "maxRunDuration": "3600s"
            },
            "taskCount": 5,
            "parallelism": 5
          }
        ],
        "allocationPolicy": {
          "instances": [
            {
              "policy": {
                "machineType": "e2-standard-2",
                "provisioningModel": "STANDARD"
              }
            }
          ],
          "location": {
            "allowedLocations": ["regions/us-central1"]
          }
        },
        "logsPolicy": {
          "destination": "CLOUD_LOGGING"
        }
      }
    }

  # 認証設定
  oauthToken:
    serviceAccountEmail: 465603676610-compute@developer.gserviceaccount.com
    scope: https://www.googleapis.com/auth/cloud-platform

# 再試行設定
retryConfig:
  retryCount: 3
  maxRetryDuration: 300s
  minBackoffDuration: 5s
  maxBackoffDuration: 60s