taskGroups:
- taskSpec:
    runnables:
    - container:
        imageUri: us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-datareader:latest
        entrypoint: /bin/bash
        commands:
        - -c
        - |
          set -e
          echo "üöÄ Massive Coverage Worker ${BATCH_TASK_INDEX:-0} started"
          
          # Environment verification
          python3 --version
          python3 -c "import yfinance; print('‚úÖ yfinance imported')"
          python3 -c "import pandas_datareader; print('‚úÖ pandas-datareader imported')"
          python3 -c "import pymysql; print('‚úÖ PyMySQL imported')"
          
          # Database connectivity test
          python3 -c "
          import pymysql
          import os
          try:
              connection = pymysql.connect(
                  host=os.getenv('DB_HOST'),
                  user=os.getenv('DB_USER'),
                  password=os.getenv('DB_PASSWORD'),
                  database=os.getenv('DB_NAME'),
                  charset='utf8mb4'
              )
              print('‚úÖ Database connection successful')
              with connection.cursor() as cursor:
                  cursor.execute('SELECT COUNT(*) FROM stock_master WHERE is_active = 1')
                  total = cursor.fetchone()[0]
                  cursor.execute('SELECT COUNT(DISTINCT sm.symbol) FROM stock_master sm LEFT JOIN stock_price_history sph ON sm.symbol = sph.symbol WHERE sm.is_active = 1 AND sph.symbol IS NULL')
                  uncovered = cursor.fetchone()[0]
                  print(f'‚úÖ Total stocks: {total:,}, Uncovered: {uncovered:,}')
              connection.close()
          except Exception as e:
              print(f'‚ùå Database connection failed: {e}')
              exit(1)
          "
          
          # Execute massive coverage collector
          python3 /app/massive_coverage_collector.py
    computeResource:
      cpuMilli: 4000
      memoryMib: 8192
    maxRetryCount: 1
    maxRunDuration: 7200s
    environment:
      variables:
        DB_HOST: "34.58.103.36"
        DB_USER: "miraikakaku-user"
        DB_PASSWORD: "miraikakaku-secure-pass-2024"
        DB_NAME: "miraikakaku"
        PYTHONUNBUFFERED: "1"
        PYTHONPATH: "/app"
        BATCH_MODE: "massive_coverage"
  taskCount: 10  # 10‰∏¶Âàó„ÅßÂ§ßË¶èÊ®°Âá¶ÁêÜ
  parallelism: 5  # 5„Å§„Åö„Å§ÂÆüË°å

allocationPolicy:
  instances:
  - policy:
      machineType: e2-standard-4
      provisioningModel: STANDARD
  location:
    allowedLocations:
    - regions/us-central1

logsPolicy:
  destination: CLOUD_LOGGING

labels:
  app: miraikakaku
  environment: production
  type: massive-coverage