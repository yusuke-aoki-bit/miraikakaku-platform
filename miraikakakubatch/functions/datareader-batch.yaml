taskGroups:
- taskSpec:
    runnables:
    - container:
        imageUri: us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-datareader:latest
        entrypoint: /bin/bash
        commands:
        - -c
        - |
          set -e
          echo "üöÄ DataReader Batch Worker ${BATCH_TASK_INDEX:-0} started"
          
          # Environment verification
          python3 --version
          pip3 list | grep pandas
          
          # Check required packages
          python3 -c "import pandas_datareader; print('‚úÖ pandas-datareader imported')"
          python3 -c "import pymysql; print('‚úÖ PyMySQL imported')"
          python3 -c "import pandas; print('‚úÖ pandas imported')"
          python3 -c "import lxml; print('‚úÖ lxml imported')"
          
          # Database connectivity test
          python3 -c "
          import pymysql
          import os
          try:
              connection = pymysql.connect(
                  host=os.getenv('DB_HOST'),
                  user=os.getenv('DB_USER'),
                  password=os.getenv('DB_PASSWORD'),
                  database=os.getenv('DB_NAME'),
                  charset='utf8mb4'
              )
              print('‚úÖ Database connection successful')
              with connection.cursor() as cursor:
                  cursor.execute('SELECT COUNT(*) FROM stock_master')
                  count = cursor.fetchone()[0]
                  print(f'‚úÖ Stock master has {count} records')
              connection.close()
          except Exception as e:
              print(f'‚ùå Database connection failed: {e}')
              exit(1)
          "
          
          # Execute datareader collector
          python3 /app/datareader_collector.py
    computeResource:
      cpuMilli: 4000
      memoryMib: 8192
    maxRetryCount: 2
    maxRunDuration: 3600s
    environment:
      variables:
        DB_HOST: "34.58.103.36"
        DB_USER: "miraikakaku-user"
        DB_PASSWORD: "miraikakaku-secure-pass-2024"
        DB_NAME: "miraikakaku"
        PYTHONUNBUFFERED: "1"
        PYTHONPATH: "/app"
        BATCH_MODE: "datareader"
  taskCount: 3
  parallelism: 2

allocationPolicy:
  instances:
  - policy:
      machineType: e2-standard-4
      provisioningModel: STANDARD
  location:
    allowedLocations:
    - regions/us-central1

logsPolicy:
  destination: CLOUD_LOGGING

labels:
  app: miraikakaku
  environment: production
  type: batch-datareader