taskGroups:
  - taskSpec:
      runnables:
        - container:
            imageUri: "us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-stable:latest"
            entrypoint: "/bin/bash"
            commands:
              - "-c"
              - |
                echo "ğŸ” å…¨éŠ˜æŸ„è©³ç´°è£œå¡«çŠ¶æ³ç¢ºèª..."
                cd /app
                
                pip install psycopg2-binary
                
                python3 -c "
                import psycopg2
                from datetime import datetime
                
                db_config = {
                    'host': '34.173.9.214',
                    'user': 'miraikakaku-user',
                    'password': 'miraikakaku-secure-pass-2024',
                    'database': 'miraikakaku',
                    'port': 5432
                }
                
                try:
                    connection = psycopg2.connect(**db_config)
                    cursor = connection.cursor()
                    print('âœ… PostgreSQLæ¥ç¶šæˆåŠŸ')
                    
                    print('\\nğŸ“Š å…¨éŠ˜æŸ„è£œå¡«çŠ¶æ³è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ')
                    print('=' * 80)
                    
                    # 1. äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å…¨éŠ˜æŸ„ã‚’å–å¾—
                    cursor.execute('''
                        SELECT 
                            symbol,
                            COUNT(*) as prediction_count,
                            COUNT(DISTINCT model_type) as model_count,
                            MAX(prediction_horizon) as max_horizon,
                            MIN(prediction_horizon) as min_horizon
                        FROM stock_predictions 
                        GROUP BY symbol 
                        ORDER BY symbol
                    ''')
                    
                    prediction_symbols = cursor.fetchall()
                    print(f'ğŸ¯ äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹éŠ˜æŸ„: {len(prediction_symbols)}éŠ˜æŸ„')
                    
                    # å„éŠ˜æŸ„ã®è©³ç´°è¡¨ç¤º
                    print('\\nğŸ“ˆ éŠ˜æŸ„åˆ¥äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿çŠ¶æ³:')
                    print('-' * 80)
                    print('éŠ˜æŸ„\\täºˆæ¸¬æ•°\\tãƒ¢ãƒ‡ãƒ«æ•°\\tæœ€å°æœŸé–“\\tæœ€å¤§æœŸé–“\\tä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿')
                    print('-' * 80)
                    
                    total_predictions = 0
                    symbols_with_price_data = 0
                    
                    for symbol, pred_count, model_count, max_horizon, min_horizon in prediction_symbols:
                        total_predictions += pred_count
                        
                        # ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª
                        try:
                            cursor.execute('SELECT COUNT(*) FROM stock_price_history WHERE symbol = %s', (symbol,))
                            price_count = cursor.fetchone()[0]
                            price_status = f'{price_count}ä»¶' if price_count > 0 else 'ãªã—'
                            if price_count > 0:
                                symbols_with_price_data += 1
                        except:
                            price_status = 'ã‚¨ãƒ©ãƒ¼'
                        
                        print(f'{symbol}\\t{pred_count}\\t{model_count}\\t{min_horizon}æ—¥\\t{max_horizon}æ—¥\\t{price_status}')
                    
                    print('-' * 80)
                    
                    # 2. ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿å­˜åœ¨ã™ã‚‹éŠ˜æŸ„ç¢ºèª
                    try:
                        cursor.execute('''
                            SELECT COUNT(DISTINCT symbol) 
                            FROM stock_price_history 
                            WHERE symbol NOT IN (SELECT DISTINCT symbol FROM stock_predictions)
                        ''')
                        price_only_symbols = cursor.fetchone()[0]
                        print(f'ğŸ’° ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿å­˜åœ¨: {price_only_symbols}éŠ˜æŸ„')
                    except:
                        price_only_symbols = 0
                    
                    # 3. ç·åˆçµ±è¨ˆ
                    print('\\nğŸ“Š ç·åˆçµ±è¨ˆ:')
                    print('-' * 40)
                    print(f'äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿å­˜åœ¨éŠ˜æŸ„: {len(prediction_symbols)}')
                    print(f'ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿å­˜åœ¨éŠ˜æŸ„: {symbols_with_price_data}')
                    print(f'ç·äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿: {total_predictions:,}ä»¶')
                    
                    # ãƒ¢ãƒ‡ãƒ«åˆ¥çµ±è¨ˆ
                    cursor.execute('''
                        SELECT model_type, COUNT(*) as count, COUNT(DISTINCT symbol) as symbols
                        FROM stock_predictions 
                        GROUP BY model_type 
                        ORDER BY model_type
                    ''')
                    
                    print('\\nğŸ¤– ãƒ¢ãƒ‡ãƒ«åˆ¥çµ±è¨ˆ:')
                    for model, count, symbols in cursor.fetchall():
                        print(f'  {model}: {count}ä»¶ ({symbols}éŠ˜æŸ„)')
                    
                    # äºˆæ¸¬æœŸé–“åˆ¥çµ±è¨ˆ
                    cursor.execute('''
                        SELECT prediction_horizon, COUNT(*) as count, COUNT(DISTINCT symbol) as symbols
                        FROM stock_predictions 
                        GROUP BY prediction_horizon 
                        ORDER BY prediction_horizon
                    ''')
                    
                    print('\\nğŸ“… äºˆæ¸¬æœŸé–“åˆ¥çµ±è¨ˆ:')
                    horizon_data = cursor.fetchall()
                    for horizon, count, symbols in horizon_data:
                        print(f'  {horizon}æ—¥: {count}ä»¶ ({symbols}éŠ˜æŸ„)')
                    
                    # 4. å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
                    print('\\nğŸ¯ å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯:')
                    print('-' * 40)
                    
                    # BATCH.mdè¦ä»¶ãƒã‚§ãƒƒã‚¯
                    target_symbols = 25
                    target_models = 5
                    current_symbols = len(prediction_symbols)
                    
                    cursor.execute('SELECT COUNT(DISTINCT model_type) FROM stock_predictions')
                    current_models = cursor.fetchone()[0]
                    
                    # 180æ—¥äºˆæ¸¬ãƒã‚§ãƒƒã‚¯
                    cursor.execute('SELECT COUNT(DISTINCT symbol) FROM stock_predictions WHERE prediction_horizon >= 180')
                    symbols_with_180d = cursor.fetchone()[0]
                    
                    print(f'éŠ˜æŸ„æ•°: {current_symbols}/{target_symbols} ({(current_symbols/target_symbols)*100:.1f}%)')
                    print(f'ãƒ¢ãƒ‡ãƒ«æ•°: {current_models}/{target_models} ({(current_models/target_models)*100:.1f}%)')
                    print(f'180æ—¥äºˆæ¸¬å¯¾å¿œéŠ˜æŸ„: {symbols_with_180d}/{current_symbols} ({(symbols_with_180d/current_symbols)*100:.1f}%)')
                    
                    # 5. ä¸è¶³éŠ˜æŸ„ã®ç‰¹å®š
                    if current_symbols < target_symbols:
                        needed = target_symbols - current_symbols
                        print(f'\\nâš ï¸ ä¸è¶³: {needed}éŠ˜æŸ„ã®è¿½åŠ ãŒå¿…è¦')
                    else:
                        print('\\nâœ… éŠ˜æŸ„æ•°ã¯ååˆ†ã§ã™')
                    
                    if symbols_with_price_data < current_symbols:
                        price_missing = current_symbols - symbols_with_price_data
                        print(f'âš ï¸ ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ä¸è¶³: {price_missing}éŠ˜æŸ„')
                    else:
                        print('âœ… å…¨éŠ˜æŸ„ã«ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨')
                    
                    print('\\n' + '='*80)
                    
                    # æœ€çµ‚åˆ¤å®š
                    if current_symbols >= target_symbols and current_models >= target_models and symbols_with_180d >= current_symbols:
                        print('ğŸ‰ å…¨éŠ˜æŸ„ã«ã¤ã„ã¦å®Œå…¨ã«è£œå¡«æ¸ˆã¿ï¼')
                    else:
                        print('â³ ä¸€éƒ¨éŠ˜æŸ„ã§è£œå¡«ãŒä¸å®Œå…¨ã§ã™')
                    
                    connection.close()
                    
                except Exception as e:
                    print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')
                    import traceback
                    traceback.print_exc()
                "
      computeResource:
        cpuMilli: "2000"
        memoryMib: "4096"
      maxRetryCount: 1
      maxRunDuration: "600s"
    taskCount: 1
    parallelism: 1

allocationPolicy:
  instances:
    - policy:
        machineType: "e2-standard-2"
  location:
    allowedLocations:
      - "regions/us-central1"

logsPolicy:
  destination: "CLOUD_LOGGING"

labels:
  app: "miraikakaku"
  type: "detailed-symbol-check"
  environment: "production"