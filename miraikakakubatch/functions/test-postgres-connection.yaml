taskGroups:
  - taskSpec:
      runnables:
        - container:
            imageUri: "us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-stable:latest"
            entrypoint: "/bin/bash"
            commands:
              - "-c"
              - |
                echo "ğŸ” PostgreSQLæ¥ç¶šãƒ†ã‚¹ãƒˆ..."
                cd /app
                
                # psycopg2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                pip install psycopg2-binary
                
                # è¤‡æ•°ã®èªè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
                python3 -c "
                import psycopg2
                
                # ãƒ†ã‚¹ãƒˆã™ã‚‹èªè¨¼æƒ…å ±
                auth_configs = [
                    {'host': '34.173.9.214', 'user': 'postgres', 'password': 'miraikakaku-secure-pass-2024', 'database': 'miraikakaku', 'port': 5432},
                    {'host': '34.173.9.214', 'user': 'miraikakaku-user', 'password': 'miraikakaku-secure-pass-2024', 'database': 'miraikakaku', 'port': 5432},
                    {'host': '34.173.9.214', 'user': 'postgres', 'password': 'postgres', 'database': 'postgres', 'port': 5432},
                    {'host': '34.173.9.214', 'user': 'postgres', 'password': '', 'database': 'postgres', 'port': 5432}
                ]
                
                for i, config in enumerate(auth_configs):
                    print(f'\\nğŸ§ª ãƒ†ã‚¹ãƒˆ {i+1}: {config[\"user\"]}@{config[\"database\"]}')
                    try:
                        connection = psycopg2.connect(**config)
                        cursor = connection.cursor()
                        cursor.execute('SELECT version()')
                        version = cursor.fetchone()[0]
                        print(f'âœ… æ¥ç¶šæˆåŠŸ! PostgreSQLãƒãƒ¼ã‚¸ãƒ§ãƒ³: {version[:50]}...')
                        
                        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§å–å¾—
                        cursor.execute('SELECT datname FROM pg_database')
                        databases = cursor.fetchall()
                        print(f'ğŸ“Š åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: {len(databases)}å€‹')
                        for db in databases[:5]:
                            print(f'  - {db[0]}')
                        
                        # ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªï¼ˆmiraikakakuãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å ´åˆï¼‰
                        if config['database'] == 'miraikakaku':
                            cursor.execute('''
                                SELECT table_name 
                                FROM information_schema.tables 
                                WHERE table_schema = \'public\'
                                LIMIT 10
                            ''')
                            tables = cursor.fetchall()
                            print(f'ğŸ“‹ miraikakakuãƒ†ãƒ¼ãƒ–ãƒ«æ•°: {len(tables)}')
                            for table in tables:
                                print(f'  - {table[0]}')
                        
                        connection.close()
                        print(f'âœ… æ­£ã—ã„èªè¨¼æƒ…å ±: {config}')
                        break
                        
                    except Exception as e:
                        print(f'âŒ æ¥ç¶šå¤±æ•—: {str(e)[:100]}...')
                        continue
                else:
                    print('âŒ ã™ã¹ã¦ã®èªè¨¼æƒ…å ±ã§ãƒ†ã‚¹ãƒˆå¤±æ•—')
                "
                
                echo "ğŸ¯ æ¥ç¶šãƒ†ã‚¹ãƒˆå®Œäº†"
      computeResource:
        cpuMilli: "1000"
        memoryMib: "2048"
      maxRetryCount: 1
      maxRunDuration: "600s"
      environment:
        variables:
          BATCH_MODE: "postgres_connection_test"
    taskCount: 1
    parallelism: 1

allocationPolicy:
  instances:
    - policy:
        machineType: "e2-standard-2"
  location:
    allowedLocations:
      - "regions/us-central1"

logsPolicy:
  destination: "CLOUD_LOGGING"

labels:
  app: "miraikakaku"
  type: "postgres-connection-test"
  environment: "production"