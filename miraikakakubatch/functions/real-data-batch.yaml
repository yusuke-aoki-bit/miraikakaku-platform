taskGroups:
- taskSpec:
    runnables:
    - container:
        imageUri: us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-datareader:latest
        entrypoint: /bin/bash
        commands:
        - -c
        - |
          set -e
          echo "üöÄ Real Data Only Worker ${BATCH_TASK_INDEX:-0} started"
          
          # Environment verification
          python3 --version
          python3 -c "import yfinance; print('‚úÖ yfinance imported')"
          python3 -c "import pandas_datareader; print('‚úÖ pandas-datareader imported')"
          python3 -c "import pymysql; print('‚úÖ PyMySQL imported')"
          
          # Database connectivity and unfetchable table check
          python3 -c "
          import pymysql
          import os
          try:
              connection = pymysql.connect(
                  host=os.getenv('DB_HOST'),
                  user=os.getenv('DB_USER'),
                  password=os.getenv('DB_PASSWORD'),
                  database=os.getenv('DB_NAME'),
                  charset='utf8mb4'
              )
              print('‚úÖ Database connection successful')
              with connection.cursor() as cursor:
                  # Check unfetchable_stocks table
                  cursor.execute('SELECT COUNT(*) FROM unfetchable_stocks')
                  unfetchable_count = cursor.fetchone()[0]
                  print(f'üìä Unfetchable stocks: {unfetchable_count:,}')
                  
                  # Check remaining uncovered stocks
                  cursor.execute('''
                      SELECT COUNT(*) FROM stock_master sm
                      LEFT JOIN stock_price_history sph ON sm.symbol = sph.symbol
                      LEFT JOIN unfetchable_stocks uf ON sm.symbol = uf.symbol
                      WHERE sm.is_active = 1 AND sph.symbol IS NULL AND uf.symbol IS NULL
                  ''')
                  remaining = cursor.fetchone()[0]
                  print(f'üéØ Remaining uncovered: {remaining:,}')
              connection.close()
          except Exception as e:
              print(f'‚ùå Database connection failed: {e}')
              exit(1)
          "
          
          # Execute real data only collector
          python3 /app/real_data_only_collector.py
    computeResource:
      cpuMilli: 4000
      memoryMib: 8192
    maxRetryCount: 1
    maxRunDuration: 3600s
    environment:
      variables:
        DB_HOST: "34.58.103.36"
        DB_USER: "miraikakaku-user"
        DB_PASSWORD: "miraikakaku-secure-pass-2024"
        DB_NAME: "miraikakaku"
        PYTHONUNBUFFERED: "1"
        PYTHONPATH: "/app"
        BATCH_MODE: "real_data_only"
  taskCount: 15  # 15‰∏¶Âàó„ÅßÈ´òÈÄüÂá¶ÁêÜ
  parallelism: 8  # 8„Å§„Åö„Å§ÂÆüË°å

allocationPolicy:
  instances:
  - policy:
      machineType: e2-standard-4
      provisioningModel: STANDARD
  location:
    allowedLocations:
    - regions/us-central1

logsPolicy:
  destination: CLOUD_LOGGING

labels:
  app: miraikakaku
  environment: production
  type: real-data-only