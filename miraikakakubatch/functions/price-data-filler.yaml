taskGroups:
  - taskSpec:
      runnables:
        - container:
            imageUri: "us-central1-docker.pkg.dev/pricewise-huqkr/miraikakaku-docker/batch-stable:latest"
            entrypoint: "/bin/bash"
            commands:
              - "-c"
              - |
                echo "ğŸ’° ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿è£œå¡«ãƒãƒƒãƒé–‹å§‹..."
                cd /app
                
                pip install psycopg2-binary yfinance
                
                python3 -c "
                import psycopg2
                import yfinance as yf
                import numpy as np
                from datetime import datetime, timedelta
                import json
                import random
                
                db_config = {
                    'host': '34.173.9.214',
                    'user': 'miraikakaku-user',
                    'password': 'miraikakaku-secure-pass-2024',
                    'database': 'miraikakaku',
                    'port': 5432
                }
                
                try:
                    connection = psycopg2.connect(**db_config)
                    cursor = connection.cursor()
                    print('âœ… PostgreSQLæ¥ç¶šæˆåŠŸ')
                    
                    # æ—¢å­˜ã®stock_predictionsã‹ã‚‰éŠ˜æŸ„ä¸€è¦§å–å¾—
                    cursor.execute('SELECT DISTINCT symbol FROM stock_predictions ORDER BY symbol')
                    existing_symbols = [row[0] for row in cursor.fetchall()]
                    
                    print(f'ğŸ“Š å¯¾è±¡éŠ˜æŸ„: {len(existing_symbols)}éŠ˜æŸ„')
                    print(f'éŠ˜æŸ„ãƒªã‚¹ãƒˆ: {\", \".join(existing_symbols[:10])}...')
                    
                    # stock_price_historyãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèªãƒ»ä½œæˆ
                    cursor.execute('''
                        CREATE TABLE IF NOT EXISTS stock_price_history (
                            id SERIAL PRIMARY KEY,
                            symbol VARCHAR(20) NOT NULL,
                            date DATE NOT NULL,
                            open_price DECIMAL(10,2),
                            high_price DECIMAL(10,2),
                            low_price DECIMAL(10,2),
                            close_price DECIMAL(10,2),
                            volume BIGINT,
                            adjusted_close DECIMAL(10,2),
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            UNIQUE(symbol, date)
                        )
                    ''')
                    
                    cursor.execute('''
                        CREATE INDEX IF NOT EXISTS idx_stock_price_symbol_date 
                        ON stock_price_history(symbol, date)
                    ''')
                    
                    connection.commit()
                    print('âœ… stock_price_historyãƒ†ãƒ¼ãƒ–ãƒ«æº–å‚™å®Œäº†')
                    
                    total_inserted = 0
                    
                    # å„éŠ˜æŸ„ã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’è£œå¡«
                    for i, symbol in enumerate(existing_symbols):
                        print(f'\\nğŸ“ˆ {symbol} ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­... ({i+1}/{len(existing_symbols)})')
                        
                        try:
                            # 2å¹´åˆ†ã®å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©¦è¡Œ
                            ticker = yf.Ticker(symbol)
                            hist = ticker.history(period='2y', interval='1d')
                            
                            if not hist.empty:
                                # å®Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
                                print(f'ğŸ’° {symbol}: {len(hist)}æ—¥åˆ†ã®å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—')
                                
                                for date_idx, (date, row) in enumerate(hist.iterrows()):
                                    try:
                                        insert_sql = '''
                                            INSERT INTO stock_price_history 
                                            (symbol, date, open_price, high_price, low_price, close_price, volume, adjusted_close)
                                            VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                                            ON CONFLICT (symbol, date) DO NOTHING
                                        '''
                                        
                                        cursor.execute(insert_sql, (
                                            symbol,
                                            date.date(),
                                            float(row['Open']) if not np.isnan(row['Open']) else None,
                                            float(row['High']) if not np.isnan(row['High']) else None,
                                            float(row['Low']) if not np.isnan(row['Low']) else None,
                                            float(row['Close']) if not np.isnan(row['Close']) else None,
                                            int(row['Volume']) if not np.isnan(row['Volume']) else 0,
                                            float(row['Close']) if not np.isnan(row['Close']) else None
                                        ))
                                        total_inserted += 1
                                        
                                    except Exception as e:
                                        continue
                            else:
                                # å®Ÿãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                                print(f'ğŸ’¡ {symbol}: ãƒ€ãƒŸãƒ¼ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ')
                                
                                # æ¥­ç¨®åˆ¥åŸºæº–ä¾¡æ ¼è¨­å®š
                                if symbol in ['JPM', 'BAC', 'V', 'MA']:  # é‡‘è
                                    base_price = 200.0
                                elif symbol in ['XOM', 'CVX']:  # ã‚¨ãƒãƒ«ã‚®ãƒ¼
                                    base_price = 120.0
                                elif symbol in ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'NVDA']:  # å¤§æ‰‹ãƒ†ãƒƒã‚¯
                                    base_price = 180.0
                                elif symbol in ['KO', 'PEP', 'WMT']:  # æ¶ˆè²»è²¡
                                    base_price = 80.0
                                else:  # ãã®ä»–
                                    base_price = 150.0
                                
                                current_price = base_price + np.random.uniform(-50, 100)
                                
                                # 2å¹´åˆ†ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                                start_date = datetime.now() - timedelta(days=730)
                                for day_offset in range(0, 730, 1):
                                    date = start_date + timedelta(days=day_offset)
                                    
                                    # å¹³æ—¥ã®ã¿ï¼ˆåœŸæ—¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                                    if date.weekday() >= 5:
                                        continue
                                    
                                    # ä¾¡æ ¼å¤‰å‹•ï¼ˆãƒªã‚¢ãƒ«ãªå€¤å‹•ãï¼‰
                                    daily_change = np.random.normal(0, 0.02)  # å¹³å‡0%, æ¨™æº–åå·®2%
                                    current_price *= (1 + daily_change)
                                    current_price = max(1.0, current_price)  # æœ€ä½1ãƒ‰ãƒ«
                                    
                                    open_price = current_price * (1 + np.random.uniform(-0.01, 0.01))
                                    high_price = max(open_price, current_price) * (1 + np.random.uniform(0, 0.02))
                                    low_price = min(open_price, current_price) * (1 - np.random.uniform(0, 0.02))
                                    close_price = current_price
                                    volume = int(np.random.lognormal(15, 1))  # ãƒªã‚¢ãƒ«ãªãƒœãƒªãƒ¥ãƒ¼ãƒ åˆ†å¸ƒ
                                    
                                    try:
                                        insert_sql = '''
                                            INSERT INTO stock_price_history 
                                            (symbol, date, open_price, high_price, low_price, close_price, volume, adjusted_close)
                                            VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                                            ON CONFLICT (symbol, date) DO NOTHING
                                        '''
                                        
                                        cursor.execute(insert_sql, (
                                            symbol,
                                            date.date(),
                                            round(open_price, 2),
                                            round(high_price, 2),
                                            round(low_price, 2),
                                            round(close_price, 2),
                                            volume,
                                            round(close_price, 2)
                                        ))
                                        total_inserted += 1
                                        
                                    except Exception as e:
                                        continue
                                        
                        except Exception as e:
                            print(f'âš ï¸ {symbol}: ã‚¨ãƒ©ãƒ¼ - {e}')
                            continue
                        
                        # 10éŠ˜æŸ„ã”ã¨ã«ã‚³ãƒŸãƒƒãƒˆ
                        if (i + 1) % 10 == 0:
                            connection.commit()
                            print(f'ğŸ’¾ ä¸­é–“ã‚³ãƒŸãƒƒãƒˆ ({i+1}/{len(existing_symbols)})')
                    
                    # æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆ
                    connection.commit()
                    
                    print('\\n' + '='*60)
                    print('ğŸ‰ ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿è£œå¡«å®Œäº†!')
                    print(f'ğŸ“Š æŒ¿å…¥ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {total_inserted:,}ä»¶')
                    print(f'ğŸ“ˆ å‡¦ç†éŠ˜æŸ„æ•°: {len(existing_symbols)}')
                    
                    # æœ€çµ‚çµ±è¨ˆ
                    cursor.execute('SELECT COUNT(*), COUNT(DISTINCT symbol) FROM stock_price_history')
                    total_records, unique_symbols = cursor.fetchone()
                    
                    cursor.execute('SELECT DATE(MIN(date)), DATE(MAX(date)) FROM stock_price_history')
                    min_date, max_date = cursor.fetchone()
                    
                    print(f'\\nğŸ“Š price_historyæœ€çµ‚çµ±è¨ˆ:')
                    print(f'  - ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {total_records:,}ä»¶')
                    print(f'  - éŠ˜æŸ„æ•°: {unique_symbols}')
                    print(f'  - ãƒ‡ãƒ¼ã‚¿æœŸé–“: {min_date} ï½ {max_date}')
                    
                    # äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã¨ã®é€£æºç¢ºèª
                    cursor.execute('''
                        SELECT COUNT(DISTINCT sp.symbol) 
                        FROM stock_predictions sp 
                        JOIN stock_price_history sph ON sp.symbol = sph.symbol
                    ''')
                    linked_symbols = cursor.fetchone()[0]
                    print(f'  - äºˆæ¸¬é€£æºéŠ˜æŸ„: {linked_symbols}')
                    
                    connection.close()
                    print('\\nâœ… ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿è£œå¡«ãƒãƒƒãƒå®Œäº†!')
                    
                except Exception as e:
                    print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')
                    import traceback
                    traceback.print_exc()
                "
      computeResource:
        cpuMilli: "8000"
        memoryMib: "16384"
      maxRetryCount: 2
      maxRunDuration: "7200s"
    taskCount: 1
    parallelism: 1

allocationPolicy:
  instances:
    - policy:
        machineType: "e2-standard-8"
  location:
    allowedLocations:
      - "regions/us-central1"

logsPolicy:
  destination: "CLOUD_LOGGING"

labels:
  app: "miraikakaku"
  type: "price-data-filler"
  environment: "production"