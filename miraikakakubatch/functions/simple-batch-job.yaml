apiVersion: batch/v1
kind: Job
metadata:
  name: training-data-batch
spec:
  taskGroups:
  - name: training-data-workers
    taskSpec:
      runnables:
      - script:
          text: |
            #!/bin/bash
            set -e
            
            echo "ğŸš€ è¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒãƒƒãƒé–‹å§‹"
            
            # Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            apt-get update && apt-get install -y python3-pip python3-dev default-libmysqlclient-dev
            pip3 install pymysql pandas numpy scikit-learn
            
            # ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            python3 << 'EOF'
            import pymysql
            import pandas as pd
            import numpy as np
            import random
            from datetime import datetime, timedelta
            import os
            
            print(f"Pod {os.getenv('BATCH_NODE_INDEX', '0')} é–‹å§‹")
            
            db_config = {
                "host": "34.58.103.36",
                "user": "miraikakaku-user",
                "password": "miraikakaku-secure-pass-2024",
                "database": "miraikakaku",
                "charset": "utf8mb4"
            }
            
            connection = pymysql.connect(**db_config)
            
            try:
                with connection.cursor() as cursor:
                    # å‡¦ç†å¯¾è±¡éŠ˜æŸ„å–å¾—
                    pod_index = int(os.getenv('BATCH_NODE_INDEX', '0'))
                    batch_size = 100
                    offset = pod_index * batch_size
                    
                    cursor.execute("""
                        SELECT symbol, name, market FROM stock_master 
                        WHERE is_active = 1 
                        ORDER BY symbol
                        LIMIT %s OFFSET %s
                    """, (batch_size, offset))
                    
                    stocks = cursor.fetchall()
                    print(f"å‡¦ç†å¯¾è±¡: {len(stocks)}éŠ˜æŸ„")
                    
                    for stock in stocks[:10]:  # æœ€åˆã®10éŠ˜æŸ„ã‚’å‡¦ç†
                        symbol = stock[0]
                        print(f"å‡¦ç†ä¸­: {symbol}")
                        
                        # ç°¡æ˜“äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                        for i in range(10):
                            prediction_date = datetime.now() - timedelta(days=random.randint(0, 30))
                            predicted_price = 100 + random.uniform(-20, 20)
                            confidence = random.uniform(0.6, 0.9)
                            
                            cursor.execute("""
                                INSERT INTO stock_predictions 
                                (symbol, prediction_date, predicted_price, confidence_score, 
                                 model_type, model_version, prediction_horizon, is_active, created_at)
                                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, NOW())
                            """, (symbol, prediction_date, predicted_price, confidence, 
                                  'batch_simple', 'v1.0', 7, 1))
                        
                        connection.commit()
                        print(f"âœ… {symbol}: 10ä»¶ã®äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†")
                    
                    print(f"Pod {pod_index} å®Œäº†")
                    
            except Exception as e:
                print(f"ã‚¨ãƒ©ãƒ¼: {e}")
            finally:
                connection.close()
            EOF
            
            echo "âœ… ãƒãƒƒãƒå‡¦ç†å®Œäº†"
      computeResource:
        cpuMilli: 1000
        memoryMib: 2048
      maxRetryCount: 1
      maxRunDuration: 1800s
    taskCount: 3
    parallelism: 3
  allocationPolicy:
    instances:
    - policy:
        machineType: e2-medium
        provisioningModel: SPOT
    location:
      allowedLocations:
      - regions/us-central1
  logsPolicy:
    destination: CLOUD_LOGGING