# Cloud Run カナリアリリース設定例

# 1. 新バージョンのデプロイ（トラフィック0%）
gcloud run deploy miraikakaku-api \
  --image gcr.io/pricewise-huqkr/miraikakaku-api:v4.1 \
  --region us-central1 \
  --no-traffic \
  --tag canary

# 2. カナリア版に10%のトラフィックを流す
gcloud run services update-traffic miraikakaku-api \
  --region us-central1 \
  --to-tags canary=10

# 3. メトリクス監視（30分〜1時間）
# - レスポンスタイム
# - エラー率
# - CPU/メモリ使用率

# 4. 問題なければ段階的に増加
gcloud run services update-traffic miraikakaku-api \
  --region us-central1 \
  --to-tags canary=30

# 5. 最終的に100%切り替え
gcloud run services update-traffic miraikakaku-api \
  --region us-central1 \
  --to-latest

# ロールバック用コマンド（問題発生時）
gcloud run services update-traffic miraikakaku-api \
  --region us-central1 \
  --to-revisions PREVIOUS_REVISION=100